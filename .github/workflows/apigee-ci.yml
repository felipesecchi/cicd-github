name: Apigee CI with Maven

on: push
  
env:
  API_VERSION: googleapi 
  # ou:
  #API_VERSION: apigeeapi

  # Default Target Apigee Organization e Environment
  DEFAULT_APIGEE_ORG: interno-ipnet-dev
  DEFAULT_APIGEE_ENV: default-dev
  TEST_HOST: apigee.ipnetsolucoes.com.br

  # Credenciais / SA
  APIGEE_CREDS_USR: ${{ secrets.APIGEE_CREDS_USR }}
  APIGEE_CREDS_PSW: ${{ secrets.APIGEE_CREDS_PSW }}
  GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}

  # Serão preenchidas nos steps de "Set Variables *"
  AUTHOR_EMAIL: ''
  APIGEE_ORG: ''
  APIGEE_ENV: ''
  APIGEE_DEPLOYMENT_SUFFIX: ''


jobs:
  Apigee-Deploy:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    # >>> AQUI VOCÊ LISTA OS PROXIES E A SA ASSOCIADA A CADA UM
    strategy:
      fail-fast: false
      matrix:
        include:
          - proxy: airports-cicd-v1
            service_account: proxy-airports-cicd@SEU_PROJETO.iam.gserviceaccount.com

          - proxy: crud-run
            service_account: proxy-crud-run@SEU_PROJETO.iam.gserviceaccount.com

          # - proxy: outro-proxy
          #   service_account: outra-sa@SEU_PROJETO.iam.gserviceaccount.com

    steps:
      - uses: actions/checkout@v3

      # Detecta se houve alteração dentro de EdgeConfig/
      - name: Detect EdgeConfig changes
        id: edgeconfig
        run: |
          echo ">>> Verificando alterações em EdgeConfig/"
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD || echo "")
          echo "Arquivos alterados:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q '^EdgeConfig/'; then
            echo "EdgeConfig alterado."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "EdgeConfig NÃO alterado."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # Detecta se HOUVE alteração nesse proxy específico da matrix
      - name: Detect proxy changes
        id: proxychanges
        run: |
          echo ">>> Verificando alterações para o proxy '${{ matrix.proxy }}'"
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD || echo "NO_DIFF")
          echo "Arquivos alterados:"
          echo "$CHANGED_FILES"

          if [ "$CHANGED_FILES" = "NO_DIFF" ]; then
            echo "Sem diff (provavelmente primeiro run). Marcando changed=true."
            echo "changed=true" >> $GITHUB_OUTPUT
          elif echo "$CHANGED_FILES" | grep -q "proxies/${{ matrix.proxy }}/"; then
            echo "Proxy '${{ matrix.proxy }}' teve alteração."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "Proxy '${{ matrix.proxy }}' NÃO teve alteração."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # Set Variables dependendo da branch
      - name: Set Variables for [Main] branch
        if: github.ref == 'refs/heads/main'
        run: |
          echo "AUTHOR_EMAIL=${GITHUB_ACTOR}" >> $GITHUB_ENV
          echo "APIGEE_ORG=${DEFAULT_APIGEE_ORG}" >> $GITHUB_ENV
          echo "APIGEE_ENV=${DEFAULT_APIGEE_ENV}" >> $GITHUB_ENV

      - name: Set Variables for [Prod] branch
        if: github.ref == 'refs/heads/prod'
        run: |
          echo "AUTHOR_EMAIL=${GITHUB_ACTOR}" >> $GITHUB_ENV
          echo "APIGEE_ORG=${DEFAULT_APIGEE_ORG}" >> $GITHUB_ENV
          echo "APIGEE_ENV=prod" >> $GITHUB_ENV
  
      - name: Set Variables for branch not [Main], not [Prod]
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/prod'
        run: |
          echo "APIGEE_DEPLOYMENT_SUFFIX=$(echo ${GITHUB_REF} | sed 's#.*/##')" >> $GITHUB_ENV
          echo "AUTHOR_EMAIL=${GITHUB_ACTOR}" >> $GITHUB_ENV
          echo "APIGEE_ORG=${DEFAULT_APIGEE_ORG}" >> $GITHUB_ENV
          echo "APIGEE_ENV=${DEFAULT_APIGEE_ENV}" >> $GITHUB_ENV

      # Java + cache Maven
      - name: Set up JDK 1.8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' 
          java-version: 8

      - name: Cache the Maven packages to speed up build
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2   

      # Gera arquivo da Service Account (deploy)
      - name: Generate SA key file
        if: env.API_VERSION == 'googleapi'
        run: | 
          echo "${GCP_SERVICE_ACCOUNT}" > sa.json

      # Deploy de EdgeConfig (só se API_VERSION == googleapi E EdgeConfig tiver mudado)
      - name: mvn deploy config xhybrid
        if: env.API_VERSION == 'googleapi' && steps.edgeconfig.outputs.changed == 'true'
        working-directory: ./EdgeConfig
        run: |
          # já estamos dentro de EdgeConfig
          sed -i "s/target_apigee_env/${APIGEE_ENV}/g" edge.json

          mvn install -q -Pgoogleapi \
            -Dapigee.org=${APIGEE_ORG} \
            -Dapigee.env=${APIGEE_ENV} \
            -Dapigee.config.options=update \
            -Dapigee.config.file=edge.json

      # Package & Deploy Apigee proxy (para cada item de matrix.proxy)
      - name: mvn package
        if: steps.proxychanges.outputs.changed == 'true'
        working-directory: proxies/${{ matrix.proxy }}
        run: |
          mvn process-resources \
            -P${API_VERSION} \
            -Dcommit=${GITHUB_SHA} \
            -Dauthor=${AUTHOR_EMAIL} \
            -Ddeployment.suffix=${APIGEE_DEPLOYMENT_SUFFIX}

      - name: mvn config
        if: steps.proxychanges.outputs.changed == 'true'
        working-directory: proxies/${{ matrix.proxy }}
        run: |
          mvn apigee-enterprise:configure -q \
            -P${API_VERSION} \
            -Dorg=${APIGEE_ORG} \
            -Denv=${APIGEE_ENV} \
            -Ddeployment.suffix=${APIGEE_DEPLOYMENT_SUFFIX}

      - name: mvn deploy proxy edge
        if: env.API_VERSION == 'apigeeapi' && steps.proxychanges.outputs.changed == 'true'
        working-directory: proxies/${{ matrix.proxy }}
        run: |
          mvn apigee-enterprise:deploy -q -Papigeeapi \
            -Dorg=${APIGEE_ORG} \
            -Denv=${APIGEE_ENV} \
            -Dpassword=${APIGEE_CREDS_PSW} \
            -Dusername=${APIGEE_CREDS_USR} \
            -Ddeployment.suffix=${APIGEE_DEPLOYMENT_SUFFIX}

      - name: mvn deploy proxy xhybrid
        if: env.API_VERSION == 'googleapi' && steps.proxychanges.outputs.changed == 'true'
        working-directory: proxies/{{ matrix.proxy }}
        run: |
          mvn apigee-enterprise:deploy -q -Pgoogleapi \
            -Denv=${APIGEE_ENV} \
            -Dsa=../../sa.json \
            -Dorg=${APIGEE_ORG} \
            -Ddeployment.suffix=${APIGEE_DEPLOYMENT_SUFFIX} \
            -DgoogleTokenEmail=${{ matrix.service_account }}
